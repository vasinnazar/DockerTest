!function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base"],a):"object"==typeof module&&module.exports?module.exports=function(b,c){return b||(b=window),void 0===c&&(c="undefined"!=typeof window?require("jquery"):require("jquery")(b)),require("./grid.base"),a(c),c}:a(jQuery)}(function(a){"use strict";var b=a.jgrid,c=a.fn.jqGrid;b.extend({groupingSetup:function(){return this.each(function(){var d,e,f,g,h,i=this,j=i.p,k=j.colModel,l=j.groupingView,m=function(){return""};if(null===l||"object"!=typeof l&&!a.isFunction(l))j.grouping=!1;else if(l.groupField.length){for(void 0===l.visibiltyOnNextGrouping&&(l.visibiltyOnNextGrouping=[]),l.lastvalues=[],l._locgr||(l.groups=[]),l.counters=[],d=0;d<l.groupField.length;d++)l.groupOrder[d]||(l.groupOrder[d]="asc"),l.groupText[d]||(l.groupText[d]="{0}"),"boolean"!=typeof l.groupColumnShow[d]&&(l.groupColumnShow[d]=!0),"boolean"!=typeof l.groupSummary[d]&&(l.groupSummary[d]=!1),l.groupSummaryPos[d]||(l.groupSummaryPos[d]="footer"),g=k[j.iColByName[l.groupField[d]]],l.groupColumnShow[d]===!0?(l.visibiltyOnNextGrouping[d]=!0,null!=g&&g.hidden===!0&&c.showCol.call(a(i),l.groupField[d])):(l.visibiltyOnNextGrouping[d]=a("#"+b.jqID(j.id+"_"+l.groupField[d])).is(":visible"),null!=g&&g.hidden!==!0&&c.hideCol.call(a(i),l.groupField[d]));for(l.summary=[],l.hideFirstGroupCol&&(l.formatDisplayField[0]=function(a){return a}),e=0,f=k.length;e<f;e++)g=k[e],l.hideFirstGroupCol&&(g.hidden||l.groupField[0]!==g.name||(g.formatter=m)),g.summaryType&&(h={nm:g.name,st:g.summaryType,v:"",sr:g.summaryRound,srt:g.summaryRoundType||"round"},g.summaryDivider&&(h.sd=g.summaryDivider,h.vd=""),l.summary.push(h))}else j.grouping=!1})},groupingPrepare:function(b,d){return this.each(function(){var e,f,g,h,i,j,k,l,m,n=this,o=n.p,p=o.groupingView,q=p.groups,r=p.counters,s=p.lastvalues,t=p.isInTheSameGroup,u=p.groupField.length,v=!1,w=c.groupingCalculations.handler,x=function(b,c){if(null==b&&p.useDefaultValuesOnGrouping){var d,e=void 0!==o.iColByName[c]?o.colModel[o.iColByName[c]]:o.additionalProperties[o.iPropByName[c]];null!=e&&null!=e.formatter&&(null!=e.formatoptions&&void 0!==e.formatoptions.defaultValue?b=e.formatoptions.defaultValue:"string"==typeof e.formatter&&void 0!==(d=a(n).jqGrid("getGridRes","formatter."+e.formatter+".defaultValue"))&&(b=d))}return b};for(e=0;e<u;e++)if(j=p.groupField[e],k=x(b[j],j),k,l=p.displayField[e],m=null==l?null:x(b[l],l),null==m&&(m=k),void 0!==k){for(g=[],f=0;f<=e;f++)g.push(b[p.groupField[f]]);for(h={idx:e,dataIndex:j,value:k,displayValue:m,startRow:d,cnt:1,keys:g,summary:[]},i={cnt:1,pos:q.length,summary:a.extend(!0,[],p.summary)},0===d?(q.push(h),s[e]=k,r[e]=i):"object"==typeof k||(a.isArray(t)&&a.isFunction(t[e])?t[e].call(n,s[e],k,e,p):s[e]===k)?v?(q.push(h),s[e]=k,r[e]=i):(i=r[e],i.cnt+=1,q[i.pos].cnt=i.cnt):(q.push(h),s[e]=k,v=!0,r[e]=i),q[i.pos].summary=function(){var c,d,e;for(c=0;c<i.summary.length;c++)d=i.summary[c],e=a.isArray(d.st)?d.st[h.idx]:d.st,a.isFunction(e)?d.v=e.call(n,d.v,d.nm,b,h):(d.v=w.call(a(n),e,d.v,d.nm,d.sr,d.srt,b),"avg"===e.toLowerCase()&&d.sd&&(d.vd=w.call(a(n),e,d.vd,d.sd,d.sr,d.srt,b)));return i.summary}(),f=i.pos-1;f>=0;f--)if(q[f].idx<q[i.pos].idx){q[i.pos].parentGroupIndex=f,q[i.pos].parentGroup=q[f];break}}}),this},getGroupHeaderIndex:function(c,d){var e=this,f=e[0],g=f.p,h=d?a(d).closest("tr.jqgroup"):a("#"+b.jqID(c)),i=parseInt(h.data("jqgrouplevel"),10),j=g.id+"ghead_"+i+"_";return isNaN(i)||!h.hasClass("jqgroup")||c.length<=j.length?-1:parseInt(c.substring(j.length),10)},groupingToggle:function(c,d){return this.each(function(){var e,f,g,h=this,i=h.p,j=i.groupingView,k=j.minusicon,l=j.plusicon,m=d?a(d).closest("tr.jqgroup"):a("#"+b.jqID(c)),n=function(a){return a.find(">td>span.tree-wrap")},o=!0,p=!1,q=[],r=function(a){var b,c=a.length;for(b=0;b<c;b++)q.push(a[b])},s=parseInt(m.data("jqgrouplevel"),10);for(i.frozenColumns&&m.length>0&&(f=m[0].rowIndex,m=a(h.rows[f]),m=m.add(h.grid.fbRows[f])),g=n(m),b.hasAllClasses(g,k)?(g.removeClass(k).addClass(l),p=!0):g.removeClass(l).addClass(k),m=m.next();m.length;m=m.next())if(m.hasClass("jqfoot")){if(e=parseInt(m.data("jqfootlevel"),10),p){if(e=parseInt(m.data("jqfootlevel"),10),(!j.showSummaryOnHide&&e===s||e>s)&&r(m),e<s)break}else if((e===s||j.showSummaryOnHide&&e===s+1)&&r(m),e<=s)break}else if(m.hasClass("jqgroup"))if(e=parseInt(m.data("jqgrouplevel"),10),p){if(e<=s)break;r(m)}else{if(e<=s)break;e===s+1&&(n(m).removeClass(k).addClass(l),r(m)),o=!1}else(p||o)&&r(m);a(q).css("display",p?"none":""),i.frozenColumns&&a(h).triggerHandler("jqGridResetFrozenHeights",[{header:{resizeDiv:!1,resizedRows:{iRowStart:-1,iRowEnd:-1}},resizeFooter:!1,body:{resizeDiv:!0,resizedRows:{iRowStart:f,iRowEnd:m.length?m[0].rowIndex-1:-1}}}]),h.fixScrollOffsetAndhBoxPadding(),a(h).triggerHandler("jqGridGroupingClickGroup",[c,p]),a.isFunction(i.onClickGroup)&&i.onClickGroup.call(h,c,p)}),!1},groupingRender:function(d,e){function f(c,d,e,f,g){var j,k,m,n,r,s,t,u,v,w,x,y,z,A=o[c],B="",C=0,D=!0;if(0!==d&&0!==o[c].idx)for(j=c;j>=0;j--)if(o[j].idx===o[c].idx-d){A=o[j];break}for(k=A.cnt,x=void 0===g?f:0;x<q;x++){for(m="&#160;",w=p[x],u=0;u<A.summary.length;u++)if(v=A.summary[u],y=a.isArray(v.st)?v.st[e.idx]:v.st,z=a.isArray(w.summaryTpl)?w.summaryTpl[e.idx]:w.summaryTpl||"{0}",v.nm===w.name){"string"==typeof y&&"avg"===y.toLowerCase()&&(v.sd&&v.vd?v.v=v.v/v.vd:v.v&&k>0&&(v.v=v.v/k));try{v.groupCount=A.cnt,v.groupIndex=A.dataIndex,v.groupValue=A.value,s=h.formatter("",v.v,x,v)}catch(a){s=v.v}m=b.format(z,s),w.summaryFormat&&(m=w.summaryFormat.call(h,e,m,s,w,v));break}n=!1,r=!1,void 0!==g&&D&&(w.hidden||(m=g,D=!1,f>1&&(n=!0,C=f-1),r=w.align,w.align="rtl"===i.direction?"right":"left",l.iconColumnName=w.name)),t=!1,C>0&&!w.hidden&&"&#160;"===m?(t=!0,r&&(w.align=r),C--):(B+="<td role='gridcell' "+h.formatCol(x,1,"")+(n?"colspan='"+f+"'":"")+">"+m+"</td>",n=!1,r&&(w.align=r),t&&(w.hidden=!1,C--))}return B}var g="",h=this[0],i=h.p,j=0,k=[],l=i.groupingView,m=a.makeArray(l.groupSummary),n=l.groupField.length,o=l.groups,p=i.colModel,q=p.length,r=i.page,s="jqGridShowHideCol.groupingRender",t=function(a){return c.getGuiStyles.call(h,"gridRow",a)},u=t("jqgroup ui-row-"+i.direction),v=t("jqfoot ui-row-"+i.direction);return a.each(p,function(a,b){var c;for(c=0;c<n;c++)if(l.groupField[c]===b.name){k[c]=a;break}}),m.reverse(),a.each(o,function(c,s){var t,w,x,y,z,A,B,C,D=i.id+"ghead_"+s.idx,E=D+"_"+c,F=a.isFunction(l.groupCollapse)?l.groupCollapse.call(h,{group:s,rowid:E}):l.groupCollapse,G=1,H=0,I=n-1===s.idx,J=null!=s.parentGroup&&s.parentGroup.collapsed,K="<span style='cursor:pointer;margin-"+("rtl"===i.direction?"right:":"left:")+12*s.idx+"px;' class='"+l.commonIconClass+" "+(F?l.plusicon:l.minusicon)+" tree-wrap' onclick=\"jQuery('#"+b.jqID(i.id).replace("\\","\\\\")+"').jqGrid('groupingToggle','"+E+"', this);return false;\"></span>";if(l._locgr&&!(s.startRow+s.cnt>(r-1)*e&&s.startRow<r*e))return!0;J&&(F=!0),void 0!==F&&(s.collapsed=F),j++;try{a.isArray(l.formatDisplayField)&&a.isFunction(l.formatDisplayField[s.idx])?(s.displayValue=l.formatDisplayField[s.idx].call(h,s.displayValue,s.value,p[k[s.idx]],s.idx,l),t=s.displayValue):t=h.formatter(E,s.displayValue,k[s.idx],s.value)}catch(a){t=s.displayValue}if(g+="<tr id='"+E+"' data-jqgrouplevel='"+s.idx+"' "+(F&&J?"style='display:none;' ":"")+"role='row' class='"+u+" "+D+"'>",C=a.isFunction(l.groupText[s.idx])?l.groupText[s.idx].call(h,t,s.cnt,s.summary):b.template(l.groupText[s.idx],t,s.cnt,s.summary),"string"!=typeof C&&"number"!=typeof C&&(C=t),"header"===l.groupSummaryPos[s.idx]?(G=1,"cb"!==p[0].name&&"cb"!==p[1].name||G++,"subgrid"!==p[0].name&&"subgrid"!==p[1].name||G++,g+=f(c,0,s,G,K+"<span class='cell-wrapper'>"+C+"</span>")):g+="<td role='gridcell' style='padding-left:"+12*s.idx+"px;' colspan='"+q+"'>"+K+C+"</td>",g+="</tr>",I){for(A=o[c+1],z=s.startRow,B=void 0!==A?A.startRow:o[c].startRow+o[c].cnt,l._locgr&&(H=(r-1)*e)>s.startRow&&(z=H),x=z;x<B&&d[x-H];x++)g+=d[x-H].join("");if("header"!==l.groupSummaryPos[s.idx]){if(void 0!==A){for(w=0;w<l.groupField.length&&A.dataIndex!==l.groupField[w];w++);j=l.groupField.length-w}for(y=0;y<j;y++)m[y]&&(g+="<tr data-jqfootlevel='"+(s.idx-y)+(F&&(s.idx-y>0||!l.showSummaryOnHide)?"' style='display:none;'":"'")+" role='row' class='"+v+"'>",g+=f(c,y,o[s.idx-y],0),g+="</tr>");j=w}}}),this.off(s).on(s,function(){var b,c,d,e,f=i.iColByName[l.iconColumnName];if(a.inArray("header",l.groupSummaryPos)>=0){for(e=0;e<p.length;e++)if(!p[e].hidden){d=e;break}if(void 0===d||f===d)return;for(b=0;b<h.rows.length;b++)c=h.rows[b],a(c).hasClass("jqgroup")&&(a(c.cells[d]).html(c.cells[f].innerHTML),a(c.cells[f]).html("&nbsp;"));l.iconColumnName=p[d].name}}),g},groupingGroupBy:function(d,e){return this.each(function(){var f,g,h=this,i=h.p,j=i.groupingView;for("string"==typeof d&&(d=[d]),i.grouping=!0,j._locgr=!1,void 0===j.visibiltyOnNextGrouping&&(j.visibiltyOnNextGrouping=[]),f=0;f<j.groupField.length;f++)g=i.colModel[i.iColByName[j.groupField[f]]],!j.groupColumnShow[f]&&j.visibiltyOnNextGrouping[f]&&null!=g&&g.hidden===!0&&c.showCol.call(a(h),j.groupField[f]);for(f=0;f<d.length;f++)j.visibiltyOnNextGrouping[f]=a(i.idSel+"_"+b.jqID(d[f])).is(":visible");i.groupingView=a.extend(i.groupingView,e||{}),j.groupField=d,a(h).trigger("reloadGrid")})},groupingRemove:function(b){return this.each(function(){var d,e=this,f=e.p,g=e.tBodies[0],h=f.groupingView;if(void 0===b&&(b=!0),f.grouping=!1,b===!0){for(d=0;d<h.groupField.length;d++)!h.groupColumnShow[d]&&h.visibiltyOnNextGrouping[d]&&c.showCol.call(a(e),h.groupField);a("tr.jqgroup, tr.jqfoot",g).remove(),a("tr.jqgrow",g).filter(":hidden").show()}else a(e).trigger("reloadGrid")})},groupingCalculations:{handler:function(a,b,c,d,e,f){var g,h,i={sum:function(){return parseFloat(b||0)+parseFloat(f[c]||0)},min:function(){return""===b?parseFloat(f[c]||0):Math.min(parseFloat(b),parseFloat(f[c]||0))},max:function(){return""===b?parseFloat(f[c]||0):Math.max(parseFloat(b),parseFloat(f[c]||0))},count:function(){return""===b&&(b=0),f.hasOwnProperty(c)?b+1:0},avg:function(){return i.sum()}};if(!i[a])throw"jqGrid Grouping No such method: "+a;return g=i[a](),null!=d&&("fixed"===e?g=g.toFixed(d):(h=Math.pow(10,d),g=Math.round(g*h)/h)),g}}})});
//# sourceMappingURL=grid.grouping.js.map