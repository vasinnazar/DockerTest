!function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery","./jquery.fmatter","./grid.grouping"],a):"object"==typeof module&&module.exports?module.exports=function(b,c){return b||(b=window),void 0===c&&(c="undefined"!=typeof window?require("jquery"):require("jquery")(b)),require("./jquery.fmatter"),require("./grid.grouping"),a(c),c}:a(jQuery)}(function(a){"use strict";function b(a,c,d){if(!(this instanceof b))return new b(a);this.aggregator=a,this.finilized=!1,this.context=c,this.pivotOptions=d}function c(b,c,d,e,f){var g,h,i=e.length,j=this,k=function(a,b){var c=a,d=b;if(null==c&&(c=""),null==d&&(d=""),c=String(c),d=String(d),this.caseSensitive||(c=c.toUpperCase(),d=d.toUpperCase()),c===d){if(a===b)return 0;if(void 0===a)return-1;if(void 0===b)return 1;if(null===a)return-1;if(null===b)return 1}return c<d?-1:1},l=function(a,b){return a=Number(a),b=Number(b),a===b?0:a<b?-1:1},m=function(a,b){return a=Math.floor(Number(a)),b=Math.floor(Number(b)),a===b?0:a<b?-1:1};for(j.items=[],j.indexesOfSourceData=[],j.trimByCollect=b,j.caseSensitive=c,j.skipSort=d,j.fieldLength=i,j.fieldNames=new Array(i),j.fieldSortDirection=new Array(i),j.fieldCompare=new Array(i),g=0;g<i;g++){switch(h=e[g],j.fieldNames[g]=h[f||"dataName"],h.sorttype){case"integer":case"int":j.fieldCompare[g]=m;break;case"number":case"currency":case"float":j.fieldCompare[g]=l;break;default:j.fieldCompare[g]=a.isFunction(h.compare)?h.compare:k}j.fieldSortDirection[g]="desc"===h.sortorder?-1:1}}var d=a.jgrid;b.prototype.calc=function(b,c,d,e,f){var g=this;if(void 0!==b)switch(g.result=g.result||0,b=parseFloat(b),g.aggregator){case"sum":g.result+=b;break;case"count":g.result++;break;case"avg":g.finilized?(g.count=g.count||0,g.result=(g.result*g.count+b)/(g.count+1),g.count++):(g.result+=b,g.count=g.count||0,g.count++);break;case"min":g.result=Math.min(g.result,b);break;case"max":g.result=Math.max(g.result,b);break;default:a.isFunction(g.aggregator)&&(g.result=g.aggregator.call(g.context,{previousResult:g.result,value:b,fieldName:c,item:d,iItem:e,items:f}))}},b.prototype.getResult=function(a,b,c){var d=this;(void 0!==d.result||c)&&(c&&void 0!==d.result&&(d.result=0,d.count=0),void 0===d.result||d.finilized||"avg"!==d.aggregator||(d.result=d.result/d.count,d.finilized=!0),a[b]=d.result)},c.prototype.compareVectorsEx=function(a,b){var c,d,e=this,f=e.fieldLength;for(c=0;c<f;c++)if(0!==(d=e.fieldCompare[c](a[c],b[c])))return{index:c,result:d};return{index:-1,result:0}},c.prototype.getIndexOfDifferences=function(a,b){return null===b||null===a?0:this.compareVectorsEx(a,b).index},c.prototype.compareVectors=function(a,b){var c=this.compareVectorsEx(a,b);return(c.index>=0?this.fieldSortDirection[c.index]:1)>0?c.result:-c.result},c.prototype.getItem=function(a){return this.items[a]},c.prototype.getIndexLength=function(){return this.items.length},c.prototype.getIndexesOfSourceData=function(a){return this.indexesOfSourceData[a]},c.prototype.createDataIndex=function(b){var c,d,e,f,g,h,i,j,k,l=this,m=b.length,n=l.fieldLength,o=l.fieldNames,p=l.indexesOfSourceData,q=l.items;for(c=0;c<m;c++){for(i=b[c],d=new Array(n),f=0;f<n;f++)void 0!==(e=i[o[f]])&&("string"==typeof e&&l.trimByCollect&&(e=a.trim(e)),d[f]=e);if(j=0,(k=q.length-1)<0)q.push(d),p.push([c]);else if(0!==(g=l.compareVectors(d,q[k])))if(1===g||l.skipSort)q.push(d),p.push([c]);else if(1!==(g=l.compareVectors(q[0],d)))if(0!==g)for(;;){if(k-j<2){q.splice(k,0,d),p.splice(k,0,[c]);break}if(h=Math.floor((j+k)/2),0===(g=l.compareVectors(q[h],d))){p[h].push(c);break}1===g?k=h:j=h}else p[0].push(c);else q.unshift(d),p.unshift([c]);else p[k].push(c)}},d.extend({pivotSetup:function(e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J=this[0],K=a.isArray,L={},M={groupField:[],groupSummary:[],groupSummaryPos:[]},N={grouping:!0,groupingView:M},O=a.extend({totals:!1,useColSpanStyle:!1,trimByCollect:!0,skipSortByX:!1,skipSortByY:!1,caseSensitive:!1,footerTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1,defaultFormatting:!0,data:e},f||{}),P=e.length,Q=O.xDimension,R=O.yDimension,S=O.aggregates,T=O.totalText||O.totals||O.rowTotals||O.totalHeader,U=K(Q)?Q.length:0,V=K(R)?R.length:0,W=K(S)?S.length:0,X=V-(1===W?1:0),Y=[],Z=[],$=[],_=[],aa=["pivotInfos"],ba=new Array(W),ca=new Array(V),da=function(b,d,f){var g=new c(O.trimByCollect,O.caseSensitive,d,b);return a.isFunction(f)&&(g.compareVectorsEx=f),g.createDataIndex(e),g},ea=function(b,c,e,f,g){var h,i,j;switch(b){case 1:h=R[f].totalText||"{0} {1} {2}",i="y"+g+"t"+f;break;case 2:h=O.totalText||"{0}",i="t";break;default:h=W>1?c.label||"{0}":a.isFunction(R[f].label)?R[f].label:H.getItem(g)[f],i="y"+g}return j=a.extend({},c,{name:i+(W>1?"a"+e:""),label:a.isFunction(h)?h.call(J,2===b?{aggregate:c,iAggregate:e,pivotOptions:O}:1===b?{yIndex:H.getItem(g),aggregate:c,iAggregate:e,yLevel:f,pivotOptions:O}:{yData:H.getItem(g)[f],yIndex:H.getItem(g),yLevel:f,pivotOptions:O}):d.template.apply(J,2===b?[String(h),c.aggregator,c.member,e]:[String(h),c.aggregator,c.member,H.getItem(g)[f],f])}),delete j.member,delete j.aggregator,j},fa=function(a,b,c){var d,e;for(d=0;d<W;d++)e=S[d],void 0===e.template&&void 0===e.formatter&&O.defaultFormatting&&(e.template="count"===e.aggregator?"integer":"number"),$.push(ea(a,e,d,b,c))},ga=function(b,c,e){var f,g,h,i;for(f=X-1;f>=c;f--)if(Z[f]){for(g=0;g<=f;g++)E=Y[g].groupHeaders,E[E.length-1].numberOfColumns+=W;for(k=R[f],h=k.totalHeader,i=k.headerOnTop,g=f+1;g<=X-1;g++)Y[g].groupHeaders.push({titleText:i&&g===f+1||!i&&g===X-1?a.isFunction(h)?h.call(J,e,f):d.template.call(J,String(h||""),e[f],f):"",startColumnName:"y"+(b-1)+"t"+f+(1===W?"":"a0"),numberOfColumns:W})}},ha=function(a){var c=new b("count"===S[a].aggregator?"sum":S[a].aggregator,J,f);return c.groupInfo={iRows:[],rows:[],ys:[],iYs:[]},c},ia=function(a,b,c,d){var e,f,g,h=H.getIndexOfDifferences(b,c);if(null!==c)for(h=Math.max(h,0),e=X-1;e>=h;e--)f="y"+a+"t"+e+(W>1?"a"+d:""),Z[e]&&void 0===C[f]&&(g=ca[e][d],g.getResult(C,f),C.pivotInfos[f]={colType:1,iA:d,a:S[d],level:e,iRows:g.groupInfo.iRows,rows:g.groupInfo.rows,ys:g.groupInfo.ys,iYs:g.groupInfo.iYs},b!==c&&(ca[e][d]=ha(d)))};if(0===U||0===W)throw"xDimension or aggregates options are not set!";for(G=da(Q,O.skipSortByX,O.compareVectorsByX),H=da(R,O.skipSortByY,O.compareVectorsByY),f.xIndex=G,f.yIndex=H,h=0;h<U;h++)j=Q[h],l={name:"x"+h,label:null!=j.label?a.isFunction(j.label)?j.label.call(J,j,h,O):j.label:j.dataName,frozen:O.frozenStaticCols},h<U-1&&!j.skipGrouping&&!j.additionalProperty&&(M.groupField.push(l.name),M.groupSummary.push(O.groupSummary),M.groupSummaryPos.push(O.groupSummaryPos)),l=a.extend(l,j),delete l.dataName,delete l.footerText,j.additionalProperty?aa.push(l.name):($.push(l),N.sortname=l.name);for(U<2&&(N.grouping=!1),M.hideFirstGroupCol=!0,h=0;h<V;h++)k=R[h],Z.push(!!(k.totals||k.rowTotals||k.totalText||k.totalHeader));for(D=H.getItem(0),fa(0,V-1,0),I=H.getIndexLength(),x=1;x<I;x++){for(y=H.getItem(x),h=H.getIndexOfDifferences(y,D),i=X-1;i>=h;i--)Z[i]&&fa(1,i,x-1);D=y,fa(0,V-1,x)}for(h=X-1;h>=0;h--)Z[h]&&fa(1,h,I-1);for(T&&fa(2),D=H.getItem(0),i=0;i<X;i++)Y.push({useColSpanStyle:O.useColSpanStyle,groupHeaders:[{titleText:a.isFunction(R[i].label)?R[i].label.call(J,{yData:D[i],yIndex:D,yLevel:i,pivotOptions:O}):D[i],startColumnName:1===W?"y0":"y0a0",numberOfColumns:W}]});for(x=1;x<I;x++){for(y=H.getItem(x),h=H.getIndexOfDifferences(y,D),ga(x,h,D),i=X-1;i>=h;i--)Y[i].groupHeaders.push({titleText:a.isFunction(R[i].label)?R[i].label.call(J,{yData:y[i],yIndex:y,yLevel:i,pivotOptions:O}):y[i],startColumnName:"y"+x+(1===W?"":"a0"),numberOfColumns:W});for(i=0;i<h;i++)E=Y[i].groupHeaders,E[E.length-1].numberOfColumns+=W;D=y}if(ga(I,0,D),T)for(h=0;h<X;h++)Y[h].groupHeaders.push({titleText:h<X-1?"":O.totalHeader||"",startColumnName:"t"+(1===W?"":"a0"),numberOfColumns:W});for(v=G.getIndexLength(),o=0;o<v;o++){for(p=G.getItem(o),q={iX:o,x:p},C={pivotInfos:q},h=0;h<U;h++)C["x"+h]=p[h];if(w=G.getIndexesOfSourceData(o),T)for(i=0;i<W;i++)ba[i]=ha(i);for(D=null,function(){var a,b;for(a=X-1;a>=0;a--)if(Z[a])for(null==ca[a]&&(ca[a]=new Array(W)),b=0;b<W;b++)ca[a][b]=ha(b)}(),x=0;x<I;x++){for(y=H.getItem(x),z=H.getIndexesOfSourceData(x),i=0;i<W;i++){for(null!==D&&ia(x-1,y,D,i),A=[],h=0;h<z.length;h++)F=z[h],a.inArray(F,w)>=0&&A.push(F);if(A.length>0){for(r=new Array(A.length),B=S[i],s=new b(B.aggregator,J,f),m=0;m<A.length;m++)h=A[m],g=e[h],r[m]=g,s.calc(g[B.member],B.member,g,h,e),T&&(t=ba[i],t.calc(g[B.member],B.member,g,h,e),u=t.groupInfo,a.inArray(h,u.iYs)<0&&(u.iYs.push(x),u.ys.push(y)),a.inArray(h,u.iRows)<0&&(u.iRows.push(h),u.rows.push(g))),function(b,c,d,f,g,h,i){var j,k,l;if(b!==c)for(j=X-1;j>=0;j--)Z[j]&&(k=ca[j][f],k.calc(g[d.member],d.member,g,h,e),l=k.groupInfo,a.inArray(i,l.iYs)<0&&(l.iYs.push(i),l.ys.push(b)),a.inArray(h,l.iRows)<0&&(l.iRows.push(h),l.rows.push(g)))}(y,D,B,i,g,h,x);n="y"+x+(1===W?"":"a"+i),s.getResult(C,n),q[n]={colType:0,iY:x,y:y,iA:i,a:B,iRows:A,rows:r}}}D=y}if(null!==D)for(i=0;i<W;i++)ia(I-1,D,D,i);if(T)for(i=0;i<W;i++)n="t"+(1===W?"":"a"+i),t=ba[i],t.getResult(C,n),u=t.groupInfo,q[n]={colType:2,iA:i,a:S[i],iRows:u.iRows,rows:u.rows,iYs:u.iYs,ys:u.ys};_.push(C)}if(O.footerTotals||O.colTotals){for(P=_.length,h=0;h<U;h++)L["x"+h]=Q[h].footerText||"";for(h=U;h<$.length;h++){for(n=$[h].name,s=new b(O.footerAggregator||"sum",J,f),m=0;m<P;m++)C=_[m],s.calc(C[n],n,C,m,_);s.getResult(L,n)}}return f.colHeaders=Y,{colModel:$,additionalProperties:aa,options:f,rows:_,groupOptions:N,groupHeaders:Y,summary:L}},jqPivot:function(b,c,e,f){return this.each(function(){function g(){var f,g=j.pivotSetup.call(i,b,c),k=g.groupHeaders,l=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c}(g.summary)>0,m=g.groupOptions.groupingView,n=d.from.call(h,g.rows);if(!c.skipSortByX)for(f=0;f<m.groupField.length;f++)n.orderBy(m.groupField[f],null!=e&&e.groupingView&&null!=e.groupingView.groupOrder&&"desc"===e.groupingView.groupOrder[f]?"d":"a","text","");if(c.data=b,j.call(i,a.extend(!0,{datastr:a.extend(n.select(),l?{userdata:g.summary}:{}),datatype:"jsonstring",footerrow:l,userDataOnFooter:l,colModel:g.colModel,additionalProperties:g.additionalProperties,pivotOptions:g.options,viewrecords:!0,sortname:c.xDimension[0].dataName},g.groupOptions,e||{})),k.length)for(f=0;f<k.length;f++)k[f]&&k[f].groupHeaders.length&&j.setGroupHeaders.call(i,k[f]);c.frozenStaticCols&&j.setFrozenColumns.call(i)}var h=this,i=a(h),j=a.fn.jqGrid;"string"==typeof b?a.ajax(a.extend({url:b,dataType:"json",success:function(a){b=d.getAccessor(a,f&&f.reader?f.reader:"rows"),g()}},f||{})):g()})}})});
//# sourceMappingURL=grid.pivot.js.map